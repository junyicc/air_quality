// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.13/esri/copyright.txt for details.
//>>built
define("esri/dijit/analysis/AnalysisBase","require dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/has dojo/json dojo/Deferred dojo/promise/all dojo/when dojo/data/ItemFileWriteStore dojo/string dojo/Evented dojo/_base/kernel dojo/Stateful ../../kernel ../../lang ../../request ../../tasks/Geoprocessor dojo/i18n!../../nls/jsapi ./utils ../../IdentityManager".split(" "),function(u,n,c,g,l,w,B,p,r,x,C,q,y,z,A,k,h,m,v,s,t){n=n([A,y],{declaredClass:"esri.dijit.analysis.AnalysisBase",
isOutputLayerItemUpdated:!1,analysisGpServer:null,toolName:null,portalUrl:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,signInPromise:null,getResultLyrInfos:!1,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,_counter:null,constructor:function(a){this.isOutputLayerItemUpdated=!1;this._rids=[];this._counter=0;this._popupInfo=[];a.analysisGpServer?this._signIn(a.analysisGpServer):a.portalUrl&&(this.portalUrl=a.portalUrl,this._signIn(a.portalUrl,!0));this.i18n={};c.mixin(this.i18n,
s.common);c.mixin(this.i18n,s.analysisTools);c.mixin(this.i18n,s.analysisMsgCodes)},execute:function(a){this.jobParams=a.jobParams;this.itemParams=this.jobParams.OutputName?a.itemParams:null;this.signInPromise.then(c.hitch(this,this._checkUser))},_checkUser:function(){var a;if(a=k.id.findCredential(this.portalUrl).userId)a=this.portalUrl+"/sharing/rest/community/users/"+a,m({url:a,content:{f:"json"}}).then(c.hitch(this,this._handleUserProfileResponse),c.hitch(this,function(a){this.emit("job-fail",
{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})}))},_handleUserProfileResponse:function(a){a.orgId?"account_admin"===a.role||"account_publisher"===a.role||"org_admin"===a.role||"org_publisher"===a.role?this.itemParams?this._checkServiceName(a.orgId):(this._submitGpJob(),this.emit("start",this.jobParams)):this.emit("job-fail",{message:this.i18n.pubRoleMsg,messageCode:"AB_0001",jobParams:this.jobParams}):this.emit("job-fail",{message:this.i18n.orgUsrMsg,jobParams:this.jobParams})},
_checkServiceName:function(a){var b;k.id.findCredential(this.portalUrl);a=this.portalUrl+"/sharing/rest/portals/"+a+"/isServiceNameAvailable";b={name:l.fromJson(this.jobParams.OutputName).serviceProperties.name,type:"Feature Service",f:"json"};m({url:a,content:b}).then(c.hitch(this,function(a){a.available?(this._createService(),this.emit("start",this.jobParams)):this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002",jobParams:this.jobParams})}),c.hitch(this,function(a){this.emit("job-fail",
{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})}))},_createService:function(){var a,b,e;a=k.id.findCredential(this.portalUrl).userId;b=l.fromJson(this.jobParams.OutputName);a&&(e=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(e&&"/"!==e?"/"+e:"")+"/createService",b={createParameters:l.toJson({currentVersion:10.2,serviceDescription:"",hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!0,maxRecordCount:2E3,supportedQueryFormats:"JSON",
capabilities:"Query",description:"",copyrightText:"",allowGeometryUpdates:!1,syncEnabled:!1,editorTrackingInfo:{enableEditorTracking:!1,enableOwnershipAccessControl:!1,allowOthersToUpdate:!0,allowOthersToDelete:!0},xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},tables:[],name:b.serviceProperties.name}),outputType:"featureService",f:"json"},m({url:a,content:b},{usePost:!0}).then(c.hitch(this,this._submitGpJob),c.hitch(this,this._handleCreateServiceError)))},
_handleCreateServiceError:function(a){this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_getSelf:function(a){return m({url:a+"/sharing/rest/portals/self",content:{culture:z.locale,f:"json"},callbackParamName:"callback",timeout:0},{})},_submitGpJob:function(a){var b;this.itemParams&&(this.currentGpItemId=a.itemId,b=l.fromJson(this.jobParams.OutputName),b.serviceProperties&&(b.serviceProperties.serviceUrl=a.serviceurl),b.itemProperties={itemId:a.itemId},
this.jobParams.OutputName=l.toJson(b));this.analysisGpServer?((!this._toolServiceUrl||!this.gp)&&this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),this.gp.setUpdateDelay(3E3),this.gp.submitJob(this.jobParams,c.hitch(this,this._gpJobComplete),c.hitch(this,this._gpJobStatus),c.hitch(this,this._gpJobFailed)),this.emit("job-submit",this.jobParams)):this._getSelf(this.portalUrl).then(c.hitch(this,function(a){this.analysisGpServer=a.helperServices.analysis&&a.helperServices.analysis.url?
a.helperServices.analysis.url:null;this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);this.gp.setUpdateDelay(3E3);this.gp.submitJob(this.jobParams,c.hitch(this,this._gpJobComplete),c.hitch(this,this._gpJobStatus),c.hitch(this,this._gpJobFailed));this.emit("job-submit",this.jobParams)}))},_updateItem:function(a){var b,e,d;if(b=k.id.findCredential(this.portalUrl).userId)return e=this.itemParams.folder,b=this.portalUrl+"/sharing/rest/content/users/"+b+(e&&"/"!==e?"/"+e:"")+"/items/"+
this.currentGpItemId+"/update",a&&(d=a.item.properties),h.isDefined(d)||(d={}),h.isDefined(d.jobUrl)||(d.jobUrl=this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId,d.jobType="GPServer",d.jobId=this._jobInfo.jobId,d.jobStatus="processing",this.itemParams.properties=d),a=c.mixin({f:"json"},this.itemParams),a.properties&&(a.properties=l.toJson(a.properties)),d={},this._popupInfo&&0<this._popupInfo.length?d.layers=g.map(this._popupInfo,function(a,d){a.description=null;var b={id:d,popupInfo:a};this._showLabels&&
this._showLabels[d]&&(b.showLabels=this._showLabels[d]);return b},this):this._showLabels&&0<this._showLabels.length&&(d.layers=g.map(this._showLabels,function(a,d){var b={id:d};this._showLabels&&this._showLabels[d]&&(b.showLabels=this._showLabels[d]);return b},this)),a.text=l.toJson(d),a=m({url:b,content:a},{usePost:!0}),a.then(c.hitch(this,this._handleItemUpdate),c.hitch(this,this._handleUpdateItemError)),a},_handleItemUpdate:function(a){this.isOutputLayerItemUpdated=!0},_handleItemDataUpdate:function(a){},
_handleUpdateItemError:function(a){this.isOutputLayerItemUpdated=!0;this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_handleErrorResponse:function(a){this.emit("job-fail",a)},_refreshItem:function(){var a,b;if(a=k.id.findCredential(this.portalUrl).userId)return b=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(b&&"/"!==b?"/"+b:"")+"/items/"+this.currentGpItemId+"/refresh",m({url:a,content:{f:"json"}},{usePost:!0})},_handleItemRefresh:function(a){},
_readItem:function(){var a,b;if(a=k.id.findCredential(this.portalUrl).userId)return b=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(b&&"/"!==b?"/"+b:"")+"/items/"+this.currentGpItemId,a=m({url:a,content:{f:"json"}}),a.then(c.hitch(this,this._updateItem))},_gpJobStatus:function(a){var b="",e=[],d,c;a.jobParams=this.jobParams;a.resultParameter=this.resultParameter;a.returnProcessInfo=this.jobParams.returnProcessInfo;a.getResultLyrInfos=this.getResultLyrInfos;a.currentGpItemId=
this.currentGpItemId;a.itemParams=this.itemParams;if("esriJobFailed"===a.jobStatus||"esriJobSucceeded"===a.jobStatus)a.message?b=a.message:a.messages&&(e=g.filter(a.messages,function(a){if(("esriJobMessageTypeError"===a.type||"esriJobMessageTypeWarning"===a.type)&&a.description&&-1!==a.description.indexOf("messageCode"))return a.description}),0<e.length&&g.forEach(e,function(e){d=l.fromJson(e.description);c="";"esriJobMessageTypeWarning"===e.type&&(a.type="warning");d.messageCode?(c=h.isDefined(this.i18n[d.messageCode])?
this.i18n[d.messageCode]:d.message,c=h.isDefined(d.params)?q.substitute(c,d.params):c,b+=c+"\x26nbsp;"):d.error&&d.error.messageCode&&(c=h.isDefined(this.i18n[d.error.messageCode])?this.i18n[d.error.messageCode]:d.error.message,c=h.isDefined(d.error.params)?q.substitute(c,d.error.params):c,b+=c+"\x26nbsp;")},this)),a.message=b,this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null,this._gpJobComplete(a)),"esriJobFailed"===a.jobStatus&&this._deleteItem(!1);this.emit("job-status",
a);this._jobInfo=a;this.itemParams&&!this.isOutputLayerItemUpdated&&this._readItem()},_updateRefreshItem:function(a){var b=[],e=a[0],d=[];this.getResultLyrInfos?(this._lyrInfos=[],this._showLabels=[],g.forEach(a,function(a,b){var c,e;if((e=a.value.url)&&-1!==e.indexOf("/FeatureServer/"))c=e.match(/[0-9]+$/g)[0],d[c]=m({url:e,content:{f:"json"},callbackParamName:"callback"})},this),a=r(d)):(b.push(this._refreshItem()),b.push(this._readItem()),a="sync");x(a,c.hitch(this,function(a){a&&(a instanceof
Array&&0<a.length)&&(g.forEach(a,function(a,d){this._lyrInfos[d]=a;a.drawingInfo&&a.drawingInfo.labelingInfo&&(this._showLabels[d]=!0)},this),b.push(this._refreshItem()),b.push(this._readItem()));r(b).then(c.hitch(this,function(a){e.outputLayerName=l.fromJson(this.jobParams.OutputName).serviceProperties.name;e.value.itemId=this.currentGpItemId;e.analysisInfo={toolName:this.toolName,jobParams:this.jobParams};this.emit("job-result",e)}),c.hitch(this,this._handleDeleteItemError))}),c.hitch(this,this._handleDeleteItemError))},
_gpJobComplete:function(a){var b;"esriJobSucceeded"===a.jobStatus&&(a.jobParams=this.jobParams,this.emit("job-success",a),r(this._getGpResultData(a)).then(c.hitch(this,function(e){e=g.filter(e,function(a){if(a.value&&!a.value.empty)return a});0===e.length?(this.currentGpItemId&&this._deleteItem(!1),this.emit("job-fail",{message:this.i18n.emptyResultInfoMsg,type:"warning",jobParams:this.jobParams})):(h.isDefined(this.itemParams)&&(this.itemParams.properties&&this.itemParams.properties.jobStatus&&"processing"===
this.itemParams.properties.jobStatus)&&(this.itemParams.properties.jobStatus="completed"),g.forEach(e,function(a){if(a.value.featureSet&&!a.value.url)a.value.featureSet.spatialReference=a.value.layerDefinition.spatialReference;else if(a.value.url&&-1!==a.value.url.indexOf("/FeatureServer/")&&a.value.layerInfo&&a.value.layerInfo.popupInfo){var b=a.value.url.match(/[0-9]+$/g)[0];this._popupInfo[b]=a.value.layerInfo.popupInfo}},this),b=e[0],this.jobParams.returnProcessInfo?this.gp.getResultData(a.jobId,
"ProcessInfo").then(c.hitch(this,function(a){var c=[];g.forEach(a.value,function(a){c.push(l.fromJson(a))},this);this.currentGpItemId?(this.itemParams.description=t.buildReport(c),this._updateRefreshItem(e)):(b.analysisReport=t.buildReport(c),this.emit("job-result",b))})):this.currentGpItemId?this._updateRefreshItem(e):this.emit("job-result",b))})))},_gpJobFailed:function(a){var b="",e=[],d,f;c.clone(a).jobParams=this.jobParams;this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null);
a.message?b=a.message:a.messages&&(e=g.filter(a.messages,function(a){if(("esriJobMessageTypeError"===a.type||"esriJobMessageTypeWarning"===a.type)&&a.description&&-1!==a.description.indexOf("messageCode"))return a.description}),0<e.length&&g.forEach(e,function(a){d=l.fromJson(a.description);f="";d.messageCode?(f=h.isDefined(this.i18n[d.messageCode])?this.i18n[d.messageCode]:d.message,f=h.isDefined(d.params)?q.substitute(f,d.params):f,b+=f+"\x26nbsp;"):d.error&&d.error.messageCode&&(f=h.isDefined(this.i18n[d.error.messageCode])?
this.i18n[d.error.messageCode]:d.error.message,f=h.isDefined(d.params)?q.substitute(f,d.error.params):f,b+=f+"\x26nbsp;")},this));a.message=b;this.emit("job-fail",a)},_getGpResultData:function(a){var b=[],c=[];"string"===typeof this.resultParameter?c.push(this.resultParameter):this.resultParameter instanceof Array&&(c=this.resultParameter);g.forEach(c,function(d,c){b.push(this.gp.getResultData(a.jobId,d))},this);return b},cancel:function(a){this.gp.cancelJob(a.jobId).then(c.hitch(this,function(a){"esriJobCancelled"===
a.jobStatus&&(this.itemParams?this._deleteItem(!0):this.emit("job-cancel",a))}),function(a){})},checkJobStatus:function(a){this.signInPromise.then(c.hitch(this,function(){this.gp.setUpdateDelay(3E3);this._checkTimer=setInterval(c.hitch(this,this._checkStatus,a,c.hitch(this,this._gpJobStatus),c.hitch(this,this._gpJobFailed)),3E3)}))},_checkStatus:function(a,b,c){this.gp.checkJobStatus(a,b,c)},_deleteItem:function(a){var b,e;if((b=k.id.findCredential(this.portalUrl).userId)&&this.itemParams)e=h.isDefined(this.itemParams.folder)?
this.itemParams.folder:"",b=this.portalUrl+"/sharing/rest/content/users/"+b+(e&&"/"!==e?"/"+e:"")+"/items/"+this.currentGpItemId+"/delete",m({url:b,content:{f:"json"}},{usePost:!0}).then(c.hitch(this,this._handleItemDelete,a),c.hitch(this,this._handleDeleteItemError))},_handleItemDelete:function(a,b){a&&this.emit("job-cancel",b)},_handleDeleteItemError:function(a){this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_initFolderStore:function(a,b){this._fportal=
new a.Portal(this.portalUrl);this._fportal.signIn().then(c.hitch(this,function(a){this.portalUser=a;this.portalUser.getFolders().then(c.hitch(this,function(a){a=t.createFolderStore(a,this.portalUser.username);b.resolve(a)}))}))},getFolderStore:function(){var a=new p,b,e,d,f;this.folderStore?a.resolve(this.folderStore):this.signInPromise.then(c.hitch(this,function(c){k.id.findCredential(this.portalUrl);b=["../../arcgis/Portal"];e=this._counter++;d=this;this._rids&&this._rids.push(e);u(b,function(b){f=
d._rids?g.indexOf(d._rids,e):-1;-1!==f&&(d._rids.splice(f,1),d._initFolderStore(b,a))})}));return a},_checkToolUrl:function(){var a=new p;this.analysisGpServer?((!this._toolServiceUrl||!this.gp)&&this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),a.resolve({success:!0})):this._getSelf(this.portalUrl).then(c.hitch(this,function(b){(this.analysisGpServer=b.helperServices.analysis&&b.helperServices.analysis.url?b.helperServices.analysis.url:null)&&this.set("toolServiceUrl",this.analysisGpServer+
"/"+this.toolName);a.resolve({success:!0})}));return a},getCreditsEstimate:function(a,b){var e,d,f,g,k;d=new p;this._checkToolUrl().then(c.hitch(this,function(h){this._toolServiceUrl?k=this._toolServiceUrl:(g=this.portalUrl&&-1!==this.portalUrl.indexOf("dev")?"dev":this.portalUrl&&-1!==this.portalUrl.indexOf("qa")?"qa":"",k="http://analysis"+g+".arcgis.com/arcgis/rest/services/tasks/GPServer/"+this.toolName);e=k.replace("/"+a,"/exts/Estimate/"+a);f=c.mixin({f:"json"},b);m({url:e,content:f},{usePost:!0}).then(function(a){d.resolve(a)},
function(a){d.resolve(a)})}));return d},_signIn:function(a,b){var e,d,f,h,l;this.signInPromise=new p;b?(e=["../../arcgis/Portal"],d=this._counter++,f=this,this._rids&&this._rids.push(d),u(e,c.hitch(this,function(b){h=f._rids?g.indexOf(f._rids,d):-1;-1!==h&&(f._rids.splice(h,1),this._portal=new b.Portal(a),this._portal.signIn().then(c.hitch(this,function(a){this.portalUser=a;this._portal.helperServices&&this._portal.helperServices.analysis&&this._portal.helperServices.analysis.url?(this.analysisGpServer=
this._portal.helperServices.analysis.url,m({url:this.analysisGpServer,content:{f:"json"},callbackParamName:"callback"}).then(c.hitch(this,function(a){l=k.id.findCredential(this.analysisGpServer);this.signInPromise.resolve(l)}),c.hitch(this,function(a){this.signInPromise.reject(a)}))):this.signInPromise.resolve(a)}),c.hitch(this,function(a){this.signInPromise.reject(a)})))}))):m({url:a,content:{f:"json"},callbackParamName:"callback"}).then(c.hitch(this,function(b){b=k.id.findCredential(a);this.portalUrl=
k.id.findServerInfo(this._toolServiceUrl).owningSystemUrl;this.signInPromise.resolve(b)}),c.hitch(this,function(a){this.signInPromise.reject(a)}));return this.signInPromise},_toolServiceUrlSetter:function(a){this._toolServiceUrl=a;this.gp=new v(a)},_setToolServiceUrlAttr:function(a){this._toolServiceUrl=a;this.gp=new v(a)}});w("extend-esri")&&c.setObject("dijit.analysis.AnalysisBase",n,k);return n});